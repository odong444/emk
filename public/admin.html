<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ ì œí’ˆ ì‚¬ì§„ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .admin-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .download-toolbar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .selection-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .select-all-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .selection-text {
            color: #666;
            font-weight: 600;
        }

        .download-actions {
            display: flex;
            gap: 10px;
        }

        .download-selected-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-selected-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
        }

        .download-selected-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .clear-selection-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .main-content {
            padding: 40px;
        }

        .connection-status {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid #ffeaa7;
        }

        .connection-status.connected {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-color: #c3e6cb;
        }

        .connection-status.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        .search-filter {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e1e8ed;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        /* êµ¬ê¸€ ë“œë¼ì´ë¸Œ ìŠ¤íƒ€ì¼ íŒŒì¼ íƒìƒ‰ê¸° */
        .file-explorer {
            background: white;
            border-radius: 15px;
            border: 2px solid #e1e8ed;
            overflow: hidden;
        }

        .explorer-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            display: grid;
            grid-template-columns: 40px 1fr 120px 100px 150px;
            gap: 15px;
            align-items: center;
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
        }

        .explorer-body {
            max-height: 600px;
            overflow-y: auto;
        }

        .folder-item, .file-item {
            display: grid;
            grid-template-columns: 40px 1fr 120px 100px 150px;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .folder-item:hover, .file-item:hover {
            background: #f8f9ff;
        }

        .folder-item.selected, .file-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        /* í´ë” ì „ì²´ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
        .folder-item {
            cursor: pointer;
        }

        .folder-item:hover .folder-toggle {
            color: #667eea;
        }

        .item-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .item-icon {
            font-size: 1.5em;
            text-align: center;
            display: none; /* ì´ëª¨í‹°ì½˜ ìˆ¨ê¹€ */
        }

        .item-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-toggle {
            background: none;
            border: none;
            font-size: 0.8em;
            color: #666;
            cursor: pointer;
            padding: 2px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: background 0.2s ease;
        }

        .folder-toggle:hover {
            background: #e0e0e0;
        }

        .item-type {
            color: #666;
            font-size: 0.9em;
        }

        .item-count {
            color: #666;
            font-size: 0.9em;
        }

        .item-size {
            color: #666;
            font-size: 0.9em;
        }

        .item-date {
            color: #666;
            font-size: 0.9em;
        }

        .folder-children {
            display: none;
        }

        .folder-children.expanded {
            display: block;
        }

        .folder-children .folder-item,
        .folder-children .file-item {
            padding-left: 60px;
            background: #fafafa;
        }

        .folder-children .folder-children .folder-item,
        .folder-children .folder-children .file-item {
            padding-left: 100px;
            background: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            min-width: 350px;
            display: none;
        }

        .download-progress.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        @media (max-width: 768px) {
            .explorer-header, .folder-item, .file-item {
                grid-template-columns: 40px 1fr 80px;
            }
            
            .item-count, .item-date {
                display: none;
            }
            
            .download-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="admin-badge">ğŸ‘‘ ê´€ë¦¬ì</div>
            <h1>ğŸ“ ì œí’ˆ ì‚¬ì§„ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
            <p>Google Drive ìŠ¤íƒ€ì¼ë¡œ íŒŒì¼ì„ íƒìƒ‰í•˜ê³  ì„ íƒí•´ì„œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</p>
        </div>

        <!-- ë‹¤ìš´ë¡œë“œ íˆ´ë°” -->
        <div class="download-toolbar">
            <div class="selection-info">
                <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox" onchange="toggleSelectAll()">
                <label for="selectAllCheckbox" class="selection-text">ì „ì²´ ì„ íƒ</label>
                <span class="selection-text" id="selectionCount">0ê°œ ì„ íƒë¨</span>
            </div>
            <div class="download-actions">
                <button class="download-selected-btn" id="downloadSelectedBtn" onclick="downloadSelected()" disabled>
                    ğŸ“¥ ì„ íƒëœ í•­ëª© ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="clear-selection-btn" onclick="clearSelection()">
                    ğŸ—‘ï¸ ì„ íƒ í•´ì œ
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- ì—°ê²° ìƒíƒœ -->
            <div class="connection-status" id="connectionStatus">
                ğŸ”„ Firebase ì—°ê²° ì¤‘...
            </div>

            <!-- í†µê³„ -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">ì´ íŒŒì¼ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSubmitters">0</div>
                    <div class="stat-label">ì œì¶œì ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalConcepts">0</div>
                    <div class="stat-label">ì´ ì»¨ì…‰ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">0 MB</div>
                    <div class="stat-label">ì´ ìš©ëŸ‰</div>
                </div>
            </div>

            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="search-filter">
                <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” ì œì¶œìëª…, ì œí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰...">
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByProduct('all')">ì „ì²´</button>
                    <button class="filter-btn" onclick="filterByProduct('ë©€í‹°ì¿ ì»¤')">ğŸ² ë©€í‹°ì¿ ì»¤</button>
                    <button class="filter-btn" onclick="filterByProduct('ì˜¤í† ìŠ¬ë¼ì´ì„œ')">ğŸ”ª ì˜¤í† ìŠ¬ë¼ì´ì„œ</button>
                    <button class="filter-btn" onclick="filterByProduct('ë“œë¦½ì»¤í”¼ë¨¸ì‹ ')">â˜• ë“œë¦½ì»¤í”¼ë¨¸ì‹ </button>
                </div>
            </div>

            <!-- íŒŒì¼ íƒìƒ‰ê¸° -->
            <div class="file-explorer">
                <div class="explorer-header">
                    <div></div>
                    <div>ì´ë¦„</div>
                    <div>ì¢…ë¥˜</div>
                    <div>íŒŒì¼ ìˆ˜</div>
                    <div>ìˆ˜ì •ì¼</div>
                </div>
                
                <div class="loading" id="loadingIndicator">
                    <div class="loading-spinner"></div>
                    <p>Firebase Storage ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <div class="explorer-body" id="explorerBody" style="display: none;">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </div>
            </div>
        </div>
    </div>

    <!-- ë‹¤ìš´ë¡œë“œ ì§„í–‰ìƒí™© -->
    <div class="download-progress" id="downloadProgress">
        <h3 id="downloadTitle">íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="downloadStatus">0 / 0 íŒŒì¼ ì™„ë£Œ</p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getStorage, ref, listAll, getDownloadURL, getMetadata } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBCt3ArxXTOp8-S-j91yF-hdxGh2zxryLw",
            authDomain: "upload-emk.firebaseapp.com",
            projectId: "upload-emk",
            storageBucket: "upload-emk.firebasestorage.app",
            messagingSenderId: "648692236374",
            appId: "1:648692236374:web:805dea9ca6549579a97bf7",
            measurementId: "G-E71YJHJGXD"
        };

        // ì „ì—­ ë³€ìˆ˜
        let app, storage;
        let allData = {};
        let filteredData = {};
        let selectedItems = new Set();
        let currentFilter = 'all';

        // Firebase ì´ˆê¸°í™”
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                storage = getStorage(app);
                
                updateConnectionStatus('connected', 'âœ… Firebase ì—°ê²° ì„±ê³µ!');
                await loadAllData();
                
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                updateConnectionStatus('error', 'âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `connection-status ${type}`;
            statusDiv.textContent = message;
        }

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            try {
                const rootRef = ref(storage, 'product-photos');
                const rootList = await listAll(rootRef);
                
                console.log('ğŸ“ ë£¨íŠ¸ í´ë” ìŠ¤ìº” ì¤‘...');
                const productData = {};
                let totalFiles = 0;
                let totalSize = 0;
                const submitters = new Set();
                let totalConcepts = 0;

                // ì œí’ˆë³„ í´ë” ìŠ¤ìº”
                for (const productRef of rootList.prefixes) {
                    const productName = productRef.name;
                    console.log(`ğŸ“¦ ${productName} í´ë” ìŠ¤ìº” ì¤‘...`);
                    
                    const productList = await listAll(productRef);
                    productData[productName] = { 
                        concepts: [], 
                        totalFiles: 0, 
                        totalSize: 0,
                        id: `product_${productName}`,
                        type: 'folder',
                        expanded: false
                    };

                    // ì»¨ì…‰ë³„ í´ë” ìŠ¤ìº”
                    for (const conceptRef of productList.prefixes) {
                        const conceptName = conceptRef.name;
                        const submitterName = conceptName.split('_')[0];
                        submitters.add(submitterName);
                        totalConcepts++;
                        
                        console.log(`ğŸ¨ ${conceptName} ìŠ¤ìº” ì¤‘...`);
                        
                        const conceptList = await listAll(conceptRef);
                        const files = [];
                        let conceptSize = 0;

                        // íŒŒì¼ë³„ ì •ë³´ ìˆ˜ì§‘
                        for (const fileRef of conceptList.items) {
                            try {
                                const metadata = await getMetadata(fileRef);
                                const downloadURL = await getDownloadURL(fileRef);
                                
                                files.push({
                                    id: `file_${fileRef.fullPath}`,
                                    name: fileRef.name,
                                    fullPath: fileRef.fullPath,
                                    downloadURL: downloadURL,
                                    size: metadata.size,
                                    timeCreated: metadata.timeCreated,
                                    type: 'file',
                                    contentType: metadata.contentType
                                });
                                
                                conceptSize += metadata.size;
                                totalFiles++;
                                totalSize += metadata.size;
                                
                            } catch (error) {
                                console.warn(`âš ï¸ íŒŒì¼ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${fileRef.fullPath}`);
                            }
                        }

                        productData[productName].concepts.push({
                            id: `concept_${productName}_${conceptName}`,
                            name: conceptName,
                            submitter: submitterName,
                            files: files,
                            fileCount: files.length,
                            totalSize: conceptSize,
                            lastModified: files.length > 0 ? Math.max(...files.map(f => new Date(f.timeCreated).getTime())) : 0,
                            type: 'folder',
                            expanded: false
                        });

                        productData[productName].totalFiles += files.length;
                        productData[productName].totalSize += conceptSize;
                    }

                    // ì»¨ì…‰ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                    productData[productName].concepts.sort((a, b) => b.lastModified - a.lastModified);
                    productData[productName].lastModified = productData[productName].concepts.length > 0 ? 
                        productData[productName].concepts[0].lastModified : 0;
                }

                // ì „ì—­ ë°ì´í„° ì €ì¥
                allData = productData;
                filteredData = productData;

                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats({
                    totalFiles,
                    totalSubmitters: submitters.size,
                    totalConcepts,
                    totalSize
                });

                // UI ì—…ë°ì´íŠ¸
                renderFileExplorer();
                
                console.log('âœ… ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('explorerBody').style.display = 'block';
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                updateConnectionStatus('error', 'âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(stats) {
            document.getElementById('totalFiles').textContent = stats.totalFiles.toLocaleString();
            document.getElementById('totalSubmitters').textContent = stats.totalSubmitters.toLocaleString();
            document.getElementById('totalConcepts').textContent = stats.totalConcepts.toLocaleString();
            document.getElementById('totalSize').textContent = formatFileSize(stats.totalSize);
        }

        // íŒŒì¼ íƒìƒ‰ê¸° ë Œë”ë§
        function renderFileExplorer() {
            const explorerBody = document.getElementById('explorerBody');
            explorerBody.innerHTML = '';

            Object.entries(filteredData).forEach(([productName, productInfo]) => {
                // ì œí’ˆ í´ë”
                const productElement = createFolderElement({
                    id: productInfo.id,
                    name: productName,
                    icon: getProductIcon(productName),
                    type: 'ì œí’ˆ í´ë”',
                    count: `${productInfo.concepts.length}ê°œ ì»¨ì…‰`,
                    size: formatFileSize(productInfo.totalSize),
                    date: new Date(productInfo.lastModified).toLocaleDateString(),
                    expanded: productInfo.expanded,
                    level: 0
                });

                explorerBody.appendChild(productElement);

                // ì»¨ì…‰ í´ë”ë“¤ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€)
                if (productInfo.expanded) {
                    const conceptsContainer = document.createElement('div');
                    conceptsContainer.className = 'folder-children expanded';
                    conceptsContainer.id = `children_${productInfo.id}`;

                    productInfo.concepts.forEach(concept => {
                        const conceptElement = createFolderElement({
                            id: concept.id,
                            name: concept.name,
                            icon: 'ğŸ¨',
                            type: 'ì»¨ì…‰ í´ë”',
                            count: `${concept.fileCount}ê°œ íŒŒì¼`,
                            size: formatFileSize(concept.totalSize),
                            date: new Date(concept.lastModified).toLocaleDateString(),
                            expanded: concept.expanded,
                            level: 1
                        });

                        conceptsContainer.appendChild(conceptElement);

                        // íŒŒì¼ë“¤ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€)
                        if (concept.expanded) {
                            const filesContainer = document.createElement('div');
                            filesContainer.className = 'folder-children expanded';
                            filesContainer.id = `children_${concept.id}`;

                            concept.files.forEach(file => {
                                const fileElement = createFileElement({
                                    id: file.id,
                                    name: file.name,
                                    icon: getFileIcon(file.contentType),
                                    type: getFileType(file.contentType),
                                    size: formatFileSize(file.size),
                                    date: new Date(file.timeCreated).toLocaleDateString(),
                                    level: 2
                                });
                                filesContainer.appendChild(fileElement);
                            });

                            conceptsContainer.appendChild(filesContainer);
                        }
                    });

                    explorerBody.appendChild(conceptsContainer);
                }
            });

            updateSelectionUI();
        }

        // í´ë” ìš”ì†Œ ìƒì„±
        function createFolderElement(folder) {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'folder-item';
            folderDiv.id = folder.id;
            if (selectedItems.has(folder.id)) {
                folderDiv.classList.add('selected');
            }

            folderDiv.innerHTML = `
                <input type="checkbox" class="item-checkbox" ${selectedItems.has(folder.id) ? 'checked' : ''} 
                       onchange="toggleSelection('${folder.id}', this.checked)" onclick="event.stopPropagation()">
                <div class="item-name">
                    <button class="folder-toggle" onclick="event.stopPropagation(); toggleFolder('${folder.id}')">
                        ${folder.expanded ? 'â–¼' : 'â–¶'}
                    </button>
                    ${folder.name}
                </div>
                <div class="item-type">${folder.type}</div>
                <div class="item-count">${folder.count}</div>
                <div class="item-date">${folder.date}</div>
            `;

            // í´ë” ì „ì²´ í´ë¦­ì‹œ í† ê¸€
            folderDiv.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox' && !e.target.classList.contains('folder-toggle')) {
                    toggleFolder(folder.id);
                }
            });

            return folderDiv;
        }

        // íŒŒì¼ ìš”ì†Œ ìƒì„±
        function createFileElement(file) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.id = file.id;
            if (selectedItems.has(file.id)) {
                fileDiv.classList.add('selected');
            }

            fileDiv.innerHTML = `
                <input type="checkbox" class="item-checkbox" ${selectedItems.has(file.id) ? 'checked' : ''} 
                       onchange="toggleSelection('${file.id}', this.checked)" onclick="event.stopPropagation()">
                <div class="item-name">${file.name}</div>
                <div class="item-type">${file.type}</div>
                <div class="item-count">${file.size}</div>
                <div class="item-date">${file.date}</div>
            `;

            return fileDiv;
        }

        // í´ë” í† ê¸€
        window.toggleFolder = function(folderId) {
            console.log('í´ë” í† ê¸€:', folderId);
            
            // ë°ì´í„°ì—ì„œ í•´ë‹¹ í´ë” ì°¾ê¸° ë° ìƒíƒœ ë³€ê²½
            Object.values(allData).forEach(product => {
                if (product.id === folderId) {
                    product.expanded = !product.expanded;
                } else {
                    product.concepts.forEach(concept => {
                        if (concept.id === folderId) {
                            concept.expanded = !concept.expanded;
                        }
                    });
                }
            });

            // UI ë‹¤ì‹œ ë Œë”ë§
            renderFileExplorer();
        };

        // ì„ íƒ í† ê¸€
        window.toggleSelection = function(itemId, checked) {
            if (checked) {
                selectedItems.add(itemId);
            } else {
                selectedItems.delete(itemId);
            }
            updateSelectionUI();
        };

        // ì „ì²´ ì„ íƒ í† ê¸€
        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            
            selectedItems.clear();
            
            if (selectAllCheckbox.checked) {
                // ëª¨ë“  í•­ëª© ì„ íƒ
                Object.values(filteredData).forEach(product => {
                    selectedItems.add(product.id);
                    product.concepts.forEach(concept => {
                        selectedItems.add(concept.id);
                        concept.files.forEach(file => {
                            selectedItems.add(file.id);
                        });
                    });
                });
            }
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            renderFileExplorer();
        };

        // ì„ íƒ í•´ì œ
        window.clearSelection = function() {
            selectedItems.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            renderFileExplorer();
        };

        // ì„ íƒ UI ì—…ë°ì´íŠ¸
        function updateSelectionUI() {
            const selectionCount = document.getElementById('selectionCount');
            const downloadBtn = document.getElementById('downloadSelectedBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            selectionCount.textContent = `${selectedItems.size}ê°œ ì„ íƒë¨`;
            downloadBtn.disabled = selectedItems.size === 0;
            
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            const totalItems = getTotalItemCount();
            if (selectedItems.size === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedItems.size === totalItems) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // ì´ ì•„ì´í…œ ìˆ˜ ê³„ì‚°
        function getTotalItemCount() {
            let count = 0;
            Object.values(filteredData).forEach(product => {
                count++; // ì œí’ˆ í´ë”
                product.concepts.forEach(concept => {
                    count++; // ì»¨ì…‰ í´ë”
                    count += concept.files.length; // íŒŒì¼ë“¤
                });
            });
            return count;
        }

        // í´ë” ì„ íƒ ë° íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadFilesToFolder(files) {
            try {
                // í´ë” ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                const directoryHandle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });

                showDownloadProgress(`${files.length}ê°œ íŒŒì¼ì„ ì„ íƒëœ í´ë”ì— ì €ì¥ ì¤‘...`);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        const response = await fetch(file.downloadURL);
                        const blob = await response.blob();
                        
                        // íŒŒì¼ëª… ì„¤ì • (ì»¨ì…‰ëª…_íŒŒì¼ëª…)
                        const fileName = `${file.conceptName}_${file.name}`;
                        
                        // ì„ íƒëœ í´ë”ì— íŒŒì¼ ì €ì¥
                        const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        updateDownloadProgress(i + 1, files.length);
                        
                    } catch (error) {
                        console.error(`íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: ${file.name}`, error);
                    }
                }
                
                hideDownloadProgress();
                alert(`âœ… ${files.length}ê°œ íŒŒì¼ì´ ì„ íƒí•œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
            } catch (error) {
                hideDownloadProgress();
                if (error.name === 'AbortError') {
                    alert('í´ë” ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.error('í´ë” ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    // File System Access APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
                    await downloadFilesLegacy(files);
                }
            }
        }

        // ê¸°ì¡´ ë°©ì‹ ë‹¤ìš´ë¡œë“œ (File System Access API ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ìš©)
        async function downloadFilesLegacy(files) {
            showDownloadProgress(`${files.length}ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ í´ë”)`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const link = document.createElement('a');
                    link.href = file.downloadURL;
                    link.download = `${file.conceptName}_${file.name}`;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    updateDownloadProgress(i + 1, files.length);
                    
                    // ë‹¤ìš´ë¡œë“œ ê°„ê²© (ë¸Œë¼ìš°ì € ì œí•œ ë°©ì§€)
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${file.name}`, error);
                }
            }
            
            hideDownloadProgress();
            alert(`âœ… ${files.length}ê°œ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ì„ íƒëœ í•­ëª© ë‹¤ìš´ë¡œë“œ
        window.downloadSelected = async function() {
            if (selectedItems.size === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedFiles = [];
            
            // ì„ íƒëœ í•­ëª©ì—ì„œ ì‹¤ì œ íŒŒì¼ë“¤ ì¶”ì¶œ
            selectedItems.forEach(itemId => {
                if (itemId.startsWith('file_')) {
                    // ì§ì ‘ ì„ íƒëœ íŒŒì¼
                    Object.values(allData).forEach(product => {
                        product.concepts.forEach(concept => {
                            const file = concept.files.find(f => f.id === itemId);
                            if (file) {
                                selectedFiles.push({
                                    ...file,
                                    productName: Object.keys(allData).find(key => allData[key].concepts.some(c => c.files.includes(file))),
                                    conceptName: concept.name
                                });
                            }
                        });
                    });
                } else if (itemId.startsWith('concept_')) {
                    // ì»¨ì…‰ í´ë” - í•´ë‹¹ ì»¨ì…‰ì˜ ëª¨ë“  íŒŒì¼
                    Object.values(allData).forEach(product => {
                        const concept = product.concepts.find(c => c.id === itemId);
                        if (concept) {
                            concept.files.forEach(file => {
                                selectedFiles.push({
                                    ...file,
                                    productName: Object.keys(allData).find(key => allData[key].concepts.includes(concept)),
                                    conceptName: concept.name
                                });
                            });
                        }
                    });
                } else if (itemId.startsWith('product_')) {
                    // ì œí’ˆ í´ë” - í•´ë‹¹ ì œí’ˆì˜ ëª¨ë“  íŒŒì¼
                    const productName = itemId.replace('product_', '');
                    const product = allData[productName];
                    if (product) {
                        product.concepts.forEach(concept => {
                            concept.files.forEach(file => {
                                selectedFiles.push({
                                    ...file,
                                    productName: productName,
                                    conceptName: concept.name
                                });
                            });
                        });
                    }
                }
            });

            if (selectedFiles.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // í´ë” ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ì™€ í•¨ê»˜ ë‹¤ìš´ë¡œë“œ
            await downloadFilesToFolder(selectedFiles);
        };

        // ë‹¤ìš´ë¡œë“œ ì§„í–‰ìƒí™© í•¨ìˆ˜ë“¤
        function showDownloadProgress(title) {
            const progressDiv = document.getElementById('downloadProgress');
            const titleDiv = document.getElementById('downloadTitle');
            const fillDiv = document.getElementById('progressFill');
            const statusDiv = document.getElementById('downloadStatus');
            
            titleDiv.textContent = title;
            fillDiv.style.width = '0%';
            statusDiv.textContent = 'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...';
            progressDiv.classList.add('active');
        }

        function updateDownloadProgress(current, total) {
            const fillDiv = document.getElementById('progressFill');
            const statusDiv = document.getElementById('downloadStatus');
            
            const percentage = (current / total) * 100;
            fillDiv.style.width = percentage + '%';
            statusDiv.textContent = `${current} / ${total} íŒŒì¼ ì™„ë£Œ (${percentage.toFixed(1)}%)`;
        }

        function hideDownloadProgress() {
            document.getElementById('downloadProgress').classList.remove('active');
        }

        // ì œí’ˆë³„ í•„í„°ë§
        window.filterByProduct = function(product) {
            currentFilter = product;
            
            // í•„í„° ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // ë°ì´í„° í•„í„°ë§
            if (product === 'all') {
                filteredData = allData;
            } else {
                filteredData = {};
                if (allData[product]) {
                    filteredData[product] = allData[product];
                }
            }

            renderFileExplorer();
        };

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filterByProduct(currentFilter);
                return;
            }

            filteredData = {};
            Object.entries(allData).forEach(([productName, productInfo]) => {
                const filteredConcepts = productInfo.concepts.filter(concept => 
                    concept.submitter.toLowerCase().includes(searchTerm) ||
                    concept.name.toLowerCase().includes(searchTerm) ||
                    productName.toLowerCase().includes(searchTerm)
                );

                if (filteredConcepts.length > 0) {
                    filteredData[productName] = {
                        ...productInfo,
                        concepts: filteredConcepts
                    };
                }
            });

            renderFileExplorer();
        });

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getProductIcon(productName) {
            const icons = {
                'ë©€í‹°ì¿ ì»¤': 'ğŸ²',
                'ì˜¤í† ìŠ¬ë¼ì´ì„œ': 'ğŸ”ª',
                'ë“œë¦½ì»¤í”¼ë¨¸ì‹ ': 'â˜•'
            };
            return icons[productName] || 'ğŸ“¦';
        }

        function getFileIcon(contentType) {
            if (contentType?.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (contentType?.startsWith('video/')) return 'ğŸ¬';
            if (contentType?.startsWith('audio/')) return 'ğŸµ';
            return 'ğŸ“„';
        }

        function getFileType(contentType) {
            if (contentType?.startsWith('image/')) return 'ì´ë¯¸ì§€';
            if (contentType?.startsWith('video/')) return 'ë¹„ë””ì˜¤';
            if (contentType?.startsWith('audio/')) return 'ì˜¤ë””ì˜¤';
            return 'íŒŒì¼';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        initializeFirebase();

        console.log('ğŸ“ Google Drive ìŠ¤íƒ€ì¼ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì¤€ë¹„ ì™„ë£Œ!');
    </script>
</body>
</html>
